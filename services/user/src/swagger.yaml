openapi: 3.0.3

info:
  title: User Service API
  version: 1.0.0
  description: |
    # API de Gerenciamento de Usu√°rios - Hotel System
    
    Esta API oferece gerenciamento completo de usu√°rios para o sistema hoteleiro.
    
    ## Principais Recursos
    
    - Cria√ß√£o, listagem, atualiza√ß√£o e remo√ß√£o de usu√°rios
    - Autentica√ß√£o via JWT
    - Controle de permiss√µes por roles (pap√©is)
    - Auto-cadastro para h√≥spedes
    
    ---
    
    ## Autentica√ß√£o JWT
    
    Todas as rotas protegidas exigem um token JWT no header de autoriza√ß√£o.
    
    ### Como obter o token:
    
    1. Fa√ßa login atrav√©s do **API Gateway** (endpoint do Auth exposto pelo gateway):
       ```
       POST http://localhost:3005/api/login
       Content-Type: application/json

       {
         "identifier": "seu_usuario",
         "password": "sua_senha"
       }
       ```
    
    2. O servi√ßo retornar√°:
       ```json
       {
         "token": "<seu_token_jwt>"
       }
       ```
    
    3. Use o token nas requisi√ß√µes:
       ```
       Authorization: Bearer <seu_token_jwt>
       ```
    
    ### Importante
    
    - O token √© v√°lido para **todos os servi√ßos**: User, Room, Reservation, Payment
    - Se n√£o tiver usu√°rio, use o endpoint `POST /self-register` (sem autentica√ß√£o)
    - Ou pe√ßa para um admin/receptionist criar via `POST /register`
    
    ---
    
    ## Roles e Permiss√µes
    
    ### Admin
    - **Acesso total** ao sistema
    - Pode criar, listar, atualizar e remover qualquer usu√°rio
    - Acesso a todos os relat√≥rios administrativos
    - √önico role que pode gerenciar outros admins
    
    ### Receptionist (Recepcionista)
    - Pode listar, criar e atualizar usu√°rios (exceto admins)
    - **N√£o pode** remover usu√°rios ou criar admins
    - Acesso √†s opera√ß√µes de h√≥spedes e reservas
    - **N√£o tem** acesso a relat√≥rios administrativos restritos
    
    ### Guest (H√≥spede)
    - Pode se auto-cadastrar via `POST /self-register`
    - Pode visualizar e atualizar apenas o pr√≥prio perfil
    - **N√£o tem** acesso a dados de outros usu√°rios
    - **N√£o tem** acesso a opera√ß√µes administrativas
    
    ---
    
    ## üìã Regras de Neg√≥cio
    
    | Opera√ß√£o | Admin | Receptionist | Guest |
    |----------|-------|--------------|-------|
    | Listar usu√°rios (`GET /users`) | Sim | Sim | N√£o |
    | Auto-cadastro (`POST /self-register`) | Sim | Sim | Sim |
    | Cadastrar usu√°rio (`POST /register`) | Sim | Sim* | N√£o |
    | Remover usu√°rio (`DELETE /users/{username}`) | Sim | N√£o | N√£o |
    | Ver pr√≥prio perfil | Sim | Sim | Sim |
    | Relat√≥rios (`GET /reports`) | Sim | N√£o | N√£o |
    
    **\*** Receptionist n√£o pode criar usu√°rios com role `admin`
    
  contact:
    name: Suporte API
    email: suporte@hotel.com

servers:
  - url: http://localhost:3005/api
    description: API Gateway (rotas expostas em `/api`)

tags:
  - name: Usu√°rios
    description: Opera√ß√µes de gerenciamento de usu√°rios (CRUD completo)
  - name: Autentica√ß√£o
    description: Opera√ß√µes de registro e valida√ß√£o de credenciais
  - name: Gest√£o
    description: Opera√ß√µes de gerenciamento de reservas e quartos
  - name: Relat√≥rios
    description: Relat√≥rios administrativos e estat√≠sticas (apenas admin)

security:
  - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Token JWT obtido atrav√©s do endpoint de login do Auth Service.
        
        Exemplo: `Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`

  schemas:
    User:
      type: object
      required:
        - username
        - role
        - email
        - document
        - phone
      properties:
        username:
          type: string
          description: Nome de usu√°rio √∫nico no sistema
          example: johndoe
          minLength: 3
          maxLength: 50
        role:
          type: string
          description: Papel/fun√ß√£o do usu√°rio no sistema
          enum:
            - admin
            - receptionist
            - guest
          example: guest
        email:
          type: string
          format: email
          description: Endere√ßo de e-mail v√°lido
          example: john@hotel.com
        document:
          type: string
          description: Documento de identifica√ß√£o (CPF, RG, Passaporte)
          example: "12345678900"
          minLength: 8
          maxLength: 20
        phone:
          type: string
          description: N√∫mero de telefone com c√≥digo do pa√≠s
          example: "+55 11 99999-9999"
          pattern: '^\+?[1-9]\d{1,14}$'

    UserInput:
      type: object
      required:
        - username
        - password
        - role
        - email
        - document
        - phone
      properties:
        username:
          type: string
          example: johndoe
          minLength: 3
          maxLength: 50
        password:
          type: string
          format: password
          description: Senha do usu√°rio (ser√° criptografada)
          example: "S3nh@F0rt3"
          minLength: 8
        role:
          type: string
          enum:
            - admin
            - receptionist
            - guest
          example: guest
        email:
          type: string
          format: email
          example: john@hotel.com
        document:
          type: string
          example: "12345678900"
          minLength: 8
          maxLength: 20
        phone:
          type: string
          example: "+55 11 99999-9999"

    Credentials:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          example: johndoe
        password:
          type: string
          format: password
          example: "S3nh@F0rt3"

    SuccessResponse:
      type: object
      properties:
        message:
          type: string
          example: Opera√ß√£o realizada com sucesso
        data:
          type: object

    Error:
      type: object
      properties:
        error:
          type: string
          example: Usu√°rio n√£o encontrado
        message:
          type: string
          example: O usu√°rio com username especificado n√£o existe no sistema
        statusCode:
          type: integer
          example: 404
        timestamp:
          type: string
          format: date-time
          example: "2025-11-22T14:30:00Z"

paths:
  /api/self-register:
    post:
      tags:
        - Autentica√ß√£o
      summary: Auto-cadastro de h√≥spede
      description: |
        Endpoint p√∫blico para auto-cadastro de novos h√≥spedes.
        
        **N√£o requer autentica√ß√£o.**
        
        O usu√°rio ser√° criado automaticamente com role `guest`.
      operationId: selfRegister
      security: []
      requestBody:
        required: true
        description: Dados do novo h√≥spede
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserInput'
            example:
              username: maria.silva
              password: "M@ri@2024"
              role: guest
              email: maria.silva@email.com
              document: "98765432100"
              phone: "+55 21 98888-7777"
      responses:
        '201':
          description: ‚úÖ Usu√°rio criado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                message: Usu√°rio criado com sucesso
                data:
                  username: maria.silva
                  role: guest
                  email: maria.silva@email.com
        '400':
          description: ‚ùå Dados inv√°lidos ou username j√° existe
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: ‚ùå Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/register:
    post:
      tags:
        - Autentica√ß√£o
      summary: üë§ Cadastro de usu√°rio (Admin/Receptionist)
      description: |
        Cadastro de novos usu√°rios por administradores ou recepcionistas.
        
        **üîê Requer autentica√ß√£o JWT.**
        
        ### Restri√ß√µes por role:
        - **Admin**: Pode criar qualquer tipo de usu√°rio
        - **Receptionist**: Pode criar apenas `guest` e `receptionist`
      operationId: register
      security:
        - BearerAuth: []
      requestBody:
        required: true
        description: Dados do novo usu√°rio
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserInput'
            example:
              username: carlos.admin
              password: "C@rl0sAdm1n"
              role: admin
              email: carlos@hotel.com
              document: "11122233344"
              phone: "+55 11 91234-5678"
      responses:
        '201':
          description: ‚úÖ Usu√°rio criado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: ‚ùå Dados inv√°lidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: üîí Token ausente ou inv√°lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: ‚õî Permiss√£o negada (receptionist tentando criar admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/validate:
    post:
      tags:
        - Autentica√ß√£o
      summary: ‚úîÔ∏è Validar credenciais
      description: |
        Valida as credenciais de um usu√°rio sem gerar token.
        
        **‚ö†Ô∏è N√£o requer autentica√ß√£o.**
        
        √ötil para verificar se username/password est√£o corretos.
      operationId: validateCredentials
      security: []
      requestBody:
        required: true
        description: Credenciais a serem validadas
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Credentials'
            example:
              username: johndoe
              password: "S3nh@F0rt3"
      responses:
        '200':
          description: ‚úÖ Credenciais v√°lidas
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Credenciais v√°lidas
      id:
                    type: string
                    example: "691fdd83350610ca7e475617"
                  role:
                    type: string
                    example: guest
                  username:
                    type: string
                    example: nathh
              example:
                valid: true
                message: Credenciais v√°lidas
                id: "691fdd83350610ca7e475617"
                role: guest
                username: nathh
        '401':
          description: ‚ùå Credenciais inv√°lidas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: Unauthorized
                message: Username ou senha incorretos
                statusCode: 401

  /api/users:
    get:
      tags:
        - Usu√°rios
      summary: üìã Listar todos os usu√°rios
      description: |
        Lista todos os usu√°rios cadastrados no sistema.
        
        **üîê Requer autentica√ß√£o JWT.**
        
        **Permiss√µes necess√°rias:** `admin` ou `receptionist`
      operationId: listUsers
      security:
        - BearerAuth: []
      parameters:
        - name: role
          in: query
          description: Filtrar por role espec√≠fico
          required: false
          schema:
            type: string
            enum:
              - admin
              - receptionist
              - guest
        - name: limit
          in: query
          description: N√∫mero m√°ximo de resultados
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: offset
          in: query
          description: N√∫mero de registros a pular (pagina√ß√£o)
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: ‚úÖ Lista de usu√°rios retornada com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
                  total:
                    type: integer
                    example: 42
                  limit:
                    type: integer
                    example: 50
                  offset:
                    type: integer
                    example: 0
              example:
                users:
                  - username: johndoe
                    role: guest
                    email: john@hotel.com
                    document: "12345678900"
                    phone: "+55 11 99999-9999"
                  - username: maria.silva
                    role: receptionist
                    email: maria@hotel.com
                    document: "98765432100"
                    phone: "+55 21 98888-7777"
                total: 2
                limit: 50
                offset: 0
        '401':
          description: üîí Token ausente ou inv√°lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: ‚õî Permiss√£o negada (guest tentando listar)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/users/{username}:
    get:
      tags:
        - Usu√°rios
      summary: üîç Buscar usu√°rio espec√≠fico
      description: |
        Retorna os dados de um usu√°rio espec√≠fico.
        
        **üîê Requer autentica√ß√£o JWT.**
        
        Guests s√≥ podem ver o pr√≥prio perfil.
      operationId: getUser
      security:
        - BearerAuth: []
      parameters:
        - name: username
          in: path
          description: Username do usu√°rio a ser buscado
          required: true
          schema:
            type: string
          example: johndoe
      responses:
        '200':
          description: ‚úÖ Usu√°rio encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: üîí Token ausente ou inv√°lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: ‚õî Permiss√£o negada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: ‚ùå Usu√°rio n√£o encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Usu√°rios
      summary: ‚úèÔ∏è Atualizar usu√°rio
      description: |
        Atualiza os dados de um usu√°rio existente.
        
        **üîê Requer autentica√ß√£o JWT.**
        
        - Guests s√≥ podem atualizar o pr√≥prio perfil
        - Receptionists n√£o podem atualizar admins
        - Admins podem atualizar qualquer usu√°rio
      operationId: updateUser
      security:
        - BearerAuth: []
      parameters:
        - name: username
          in: path
          description: Username do usu√°rio a ser atualizado
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                phone:
                  type: string
                document:
                  type: string
            example:
              email: newemail@hotel.com
              phone: "+55 11 91111-2222"
      responses:
        '200':
          description: ‚úÖ Usu√°rio atualizado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: ‚ùå Dados inv√°lidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: üîí Token ausente ou inv√°lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: ‚õî Permiss√£o negada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: ‚ùå Usu√°rio n√£o encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags:
        - Usu√°rios
      summary: üóëÔ∏è Remover usu√°rio
      description: |
        Remove um usu√°rio do sistema permanentemente.
        
        **üîê Requer autentica√ß√£o JWT.**
        
        **‚ö†Ô∏è ATEN√á√ÉO:** Apenas administradores podem remover usu√°rios.
        Esta a√ß√£o √© irrevers√≠vel!
      operationId: deleteUser
      security:
        - BearerAuth: []
      parameters:
        - name: username
          in: path
          description: Username do usu√°rio a ser removido
          required: true
          schema:
            type: string
          example: johndoe
      responses:
        '200':
          description: ‚úÖ Usu√°rio removido com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
              example:
                message: Usu√°rio removido com sucesso
                data:
                  username: johndoe
                  deletedAt: "2025-11-22T14:30:00Z"
        '401':
          description: üîí Token ausente ou inv√°lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: ‚õî Permiss√£o negada (apenas admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: ‚ùå Usu√°rio n√£o encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/manage-reservations:
    put:
      tags:
        - Gest√£o
      summary: üóìÔ∏è Gerenciar reservas do usu√°rio
      description: |
        Atualiza as reservas associadas a um usu√°rio.
        
        **üîê Requer autentica√ß√£o JWT.**
      operationId: manageReservations
      security:
        - BearerAuth: []
      requestBody:
        required: true
        description: Dados das reservas a serem gerenciadas
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  example: johndoe
                reservations:
                  type: array
                  items:
                    type: object
                    properties:
                      reservationId:
                        type: string
                      action:
                        type: string
                        enum:
                          - add
                          - remove
                          - update
      responses:
        '200':
          description: ‚úÖ Reservas atualizadas com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: ‚ùå Dados inv√°lidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: üîí Token ausente ou inv√°lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/manage-rooms:
    put:
      tags:
        - Gest√£o
      summary: üõèÔ∏è Gerenciar quartos do usu√°rio
      description: |
        Atualiza os quartos associados a um usu√°rio.
        
        **üîê Requer autentica√ß√£o JWT.**
      operationId: manageRooms
      security:
        - BearerAuth: []
      requestBody:
        required: true
        description: Dados dos quartos a serem gerenciados
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  example: johndoe
                rooms:
                  type: array
                  items:
                    type: object
                    properties:
                      roomId:
                        type: string
                      action:
                        type: string
                        enum:
                          - assign
                          - unassign
      responses:
        '200':
          description: ‚úÖ Quartos atualizados com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: ‚ùå Dados inv√°lidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: üîí Token ausente ou inv√°lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/reports:
    get:
      tags:
        - Relat√≥rios
      summary: üìä Relat√≥rios administrativos
      description: |
        Gera relat√≥rios administrativos do sistema.
        
        **üîê Requer autentica√ß√£o JWT.**
        
        **‚ö†Ô∏è Apenas administradores t√™m acesso.**
        
        Tipos de relat√≥rios dispon√≠veis:
        - Estat√≠sticas de usu√°rios
        - Atividades recentes
        - M√©tricas de acesso
      operationId: getReports
      security:
        - BearerAuth: []
      parameters:
        - name: type
          in: query
          description: Tipo de relat√≥rio
          required: false
          schema:
            type: string
            enum:
              - users
              - activity
              - metrics
            default: users
        - name: startDate
          in: query
          description: Data inicial do per√≠odo
          required: false
          schema:
            type: string
            format: date
            example: "2025-01-01"
        - name: endDate
          in: query
          description: Data final do per√≠odo
          required: false
          schema:
            type: string
            format: date
            example: "2025-12-31"
      responses:
        '200':
          description: ‚úÖ Relat√≥rio gerado com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  reportType:
                    type: string
                    example: users
                  generatedAt:
                    type: string
                    format: date-time
                    example: "2025-11-22T14:30:00Z"
                  data:
                    type: object
              example:
                reportType: users
                generatedAt: "2025-11-22T14:30:00Z"
                data:
                  totalUsers: 150
                  byRole:
                    admin: 5
                    receptionist: 15
                    guest: 130
                  newUsersThisMonth: 25
        '401':
          description: üîí Token ausente ou inv√°lido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: ‚õî Permiss√£o negada (apenas admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'