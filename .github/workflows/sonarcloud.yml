name: SonarCloud

on:
  push:
    branches: [ main, ci/add-environments ]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch: {}

jobs:
  analyze:
    name: SonarCloud Scan
    runs-on: ubuntu-latest
    environment: development
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Run tests (skip integration)
        run: npm test --if-present -- --testPathIgnorePatterns="/tests/integration/"

      - name: Set up Java 17
        id: setup-java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Java diagnostics
        run: |
          echo "== java -version =="
          java -version || true
          echo "== which java && java -XshowSettings:properties -version (JAVA_HOME) =="
          which java || true
          echo "JAVA_HOME=$JAVA_HOME"
          java -XshowSettings:properties -version 2>&1 | sed -n '1,40p' || true

      - name: Download SonarScanner CLI
        run: |
          SONAR_VER=4.8.1.3023
          curl -sSLo sonar-scanner.zip "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SONAR_VER}-linux.zip"
          unzip sonar-scanner.zip
          mv sonar-scanner-${SONAR_VER}-linux sonar-scanner
          # Remove bundled JRE so the scanner uses the Java installed by actions/setup-java
          if [ -d "sonar-scanner/jre" ]; then
            echo "Removing bundled JRE at sonar-scanner/jre to force system Java"
            rm -rf sonar-scanner/jre
          fi
          echo "SONAR_SCANNER_HOME=$PWD/sonar-scanner" >> $GITHUB_ENV

      - name: Run SonarScanner (CLI)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          JAVA_HOME: ${{ steps.setup-java.outputs.java-home }}
          PATH: ${{ steps.setup-java.outputs.java-home }}/bin:${{ env.PATH }}
        run: |
          echo "SONAR_SCANNER_HOME=$SONAR_SCANNER_HOME"
          if [ -x "$SONAR_SCANNER_HOME/bin/sonar-scanner" ]; then
            echo "sonar-scanner exists"
            $SONAR_SCANNER_HOME/bin/sonar-scanner --version || true
          else
            echo "sonar-scanner not found at $SONAR_SCANNER_HOME"
          fi
          # Aggregate LCOV reports if present
          mkdir -p coverage-aggregate
          find services -type f -path "*/coverage/lcov.info" -print0 | xargs -0 cat > coverage-aggregate/lcov.info || true
          echo "--- DIAGNOSTICS BEFORE SCANNER ---"
          echo "which java: $(which java || true)"
          echo "readlink java: $(readlink -f $(which java) || true)"
          echo "JAVA_HOME=$JAVA_HOME"
          echo "PATH=$PATH"
          echo "ls -la SONAR_SCANNER_HOME/bin:"; ls -la "$SONAR_SCANNER_HOME/bin" || true
          echo "ls -la SONAR_SCANNER_HOME/jre/bin:"; ls -la "$SONAR_SCANNER_HOME/jre/bin" || true
          echo "ls -la SONAR_SCANNER_HOME/lib:"; ls -la "$SONAR_SCANNER_HOME/lib" || true
          echo "ps aux | grep -E 'java|sonar'"; ps aux | grep -E 'java|sonar' || true

          echo "Using explicit java at: $JAVA_HOME/bin/java"
          $JAVA_HOME/bin/java -version || true

          # Try invoking the scanner using the jar directly (force runner java)
          # Invoke the scanner main class with the runner Java and enable scanner debug (-X)
          echo "Invoking scanner via classpath using runner Java"
          $JAVA_HOME/bin/java -cp "$SONAR_SCANNER_HOME/lib/*" org.sonarsource.scanner.cli.Main -X \
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }} \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.login=$SONAR_TOKEN \
            -Dsonar.sources=services \
            -Dsonar.javascript.lcov.reportPaths=coverage-aggregate/lcov.info || true
          echo "--- DIAGNOSTICS AFTER SCANNER ATTEMPT ---"
          ps aux | grep -E 'java|sonar' || true

  deploy-prod:
    name: Deploy (production placeholder)
    needs: analyze
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deployment placeholder
        run: |
          echo "This job is a protected production deployment placeholder."
          echo "Configure real deployment steps and production environment secrets before enabling."
