name: SonarCloud

on:
  push:
    branches: [ main, ci/add-environments ]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch: {}

jobs:
  analyze:
    name: SonarCloud Scan
    runs-on: ubuntu-latest
    environment: development
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Run tests (skip integration)
        run: npm test --if-present -- --testPathIgnorePatterns="/tests/integration/"

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Download SonarScanner CLI
        run: |
          SONAR_VER=4.8.1.3023
          curl -sSLo sonar-scanner.zip "https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SONAR_VER}-linux.zip"
          unzip sonar-scanner.zip
          mv sonar-scanner-${SONAR_VER}-linux sonar-scanner
          echo "SONAR_SCANNER_HOME=$PWD/sonar-scanner" >> $GITHUB_ENV

      - name: Run SonarScanner (CLI)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          # Aggregate LCOV reports if present
          mkdir -p coverage-aggregate
          find services -type f -path "*/coverage/lcov.info" -print0 | xargs -0 cat > coverage-aggregate/lcov.info || true

          $SONAR_SCANNER_HOME/bin/sonar-scanner \
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }} \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.login=$SONAR_TOKEN \
            -Dsonar.sources=services \
            -Dsonar.javascript.lcov.reportPaths=coverage-aggregate/lcov.info

  deploy-prod:
    name: Deploy (production placeholder)
    needs: analyze
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deployment placeholder
        run: |
          echo "This job is a protected production deployment placeholder."
          echo "Configure real deployment steps and production environment secrets before enabling."
